---
id: 6e4516ff-0701-4009-9841-b0f023ca43a6
title: ğŸš¢ LLMéƒ¨ç½²(docker+vllm+embedding+rerank) æ”¯æŒå·¥å…·è°ƒç”¨
slug: 6e4516ff-0701-4009-9841-b0f023ca43a6
excerpt: è¯¥æ–‡æ¡£ä»‹ç»äº†å…³äºLLMæ¨¡å‹éƒ¨ç½²çš„å†…å®¹ï¼ŒåŒ…æ‹¬æ¨¡å‹é€‰æ‹©ã€æ¨¡å‹ä¸‹è½½ã€æ¨¡å‹éƒ¨ç½²æ–¹æ¡ˆä»¥åŠæ¨¡å‹ä½¿ç”¨å’ŒåŠ é€Ÿæ–¹æ³•ã€‚æ¨èçš„éƒ¨ç½²æ–¹æ¡ˆæ˜¯ä½¿ç”¨dockeréƒ¨ç½²ï¼ŒåŒæ—¶æä¾›äº†æœ¬åœ°ç¯å¢ƒéƒ¨ç½²çš„æ–¹æ³•ã€‚æ¨¡å‹åŠ é€Ÿæ–¹é¢ä»‹ç»äº†vllmå’Œflash-attentionä¸¤ç§æ–¹æ³•ã€‚embddingæ¨¡å‹ï¼Œrerankæ¨¡å‹
date: Mon Jun 03 2024 08:00:00 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)
coverImage: /images/6e4516ff-0701-4009-9841-b0f023ca43a6_7a2d1d060c9fb10000ed4af843e17828.png
lastUpdated: Thu Mar 27 2025 15:39:00 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)
tags: orange:LLM
readTime: 8.575
---

# æ¨¡å‹é€‰æ‹©


LLMæ¨¡å‹ï¼ŒEmbeddingæ¨¡å‹é€‰æ‹©å‚è€ƒä¸‹é¢çš„æ–‡ç« 


[link_to_page](https://testblog.wileyzhang.com/posts/4ab81ed7-7622-4ef1-9fc6-1e1ae4edbd99)


# æ¨¡å‹ä¸‹è½½


å½“å‰æä¾›æ¨¡å‹çš„ç½‘ç«™ä¸»è¦æœ‰[ModelScope](https://www.modelscope.cn/models)å’Œ[HuggingFace](https://huggingface.co/models)ï¼Œä¸‹è½½æ–¹å¼ä¸»è¦æ˜¯git lfså’Œå¹³å°å°è£…ä¸¤ç§æ–¹æ³•


## ModelScope

1. å®‰è£…modelscope

    ```shell
    pip install modelscope
    ```

2. å¤åˆ¶æ¨¡å‹åç§°

    ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/da864e11-683f-4c2d-a264-16ecdf57fff9/94c1b3e8-aeeb-4fdb-adf5-fedb3bad4f75/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UVIHBQRV%2F20250707%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250707T081153Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEGMaCXVzLXdlc3QtMiJHMEUCID1t2yK%2B2TKIb8uPD07w%2FHnI7bCdmQT%2F7lRYohLaFbrpAiEA4f4tMG9t9OtLUlw737lqQMvF%2FVakc%2Fb54A1m%2F8KHpB0q%2FwMIbBAAGgw2Mzc0MjMxODM4MDUiDPi9PPh0Hw1gVvLynircA1WiB3VwwVUZ0g91GiVI%2BX%2BSfBHY5tEsj9NBz8S4wXuxOA2406iTfj%2F6%2B8ubfLpgALI11KZ0yY85ybjYPOa1y6DTqxUmaBkk1aoJvJ3J%2B069QTtUzmK7H2U1tNfp7n7VtUQCuQYCdrbeHE3v6Ei3PUrP%2FlXJPsOT5FUR%2B9d6fwcLosdYdyUpFJXJ7W%2BoSss%2BPg0IaqUh%2FN6uyaZNJQgOm2DA0p6EkLr6R8MpFs6JV%2FJLffr1Bb3td5CYBhX6jMNmWIjmjJmF9Y%2BBqSSmZBb7%2B7IIFEW7OREWSYiHqa9gx0vbRh0c%2Fa%2FZ5V52W2qImV79OAh78HqsJUoGi5tm07p8qcfytmcJCM5YWyzx8x9MwAjcdL0qc%2FVGI19p0Me3pBJ8b46GFpekJagUGBuHrnetwTfheUP7ucxwz50R%2FkXLWW3H756%2F8Vy6jddykI2KGB0vGCn4sYoHUATE9sHCOSewq3q6%2FAb5rcf0Ip7GK%2F0DlLmZ61cL9ScReJQqQzbeiF4W1E2lvC0I5IdvZDVBbii78rX8mjdWnq7xX4EF6maRsRuRPef6lOveEWkuPhA6mXDQHt7%2FQ0N2EW%2Ba%2BLg0tWxJcJTJUhwNBlAKbWfFnKq5Y7Ga8j5PrzHyWcAByTX6MI%2F0rMMGOqUBHREYmm68cs28eyt8CQqzgjxbBuElgyc%2FaHoCHEDhJW%2Fvqs8lDIOBf3Gt2FJn%2FhmBHdezk4mCnq6m%2Ft%2FIbKPE%2B6hCfWEene1mjBFO9ICupSAQDQcL35nkKDXRh5B0qbi5qsu9ZdHW8xwl4GoraRfYaOfNxRe4ba6g44duZof46pEo%2FCL%2BWjXc0As7e%2BEWqBKNUVItuHMb1hBjlIVhP3F7w8b%2FLKod&X-Amz-Signature=dea5d07e0757490bcf06b47e5795a6124c3407bdeecf336082938feb70af89e0&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

3. ä¸‹è½½æ¨¡å‹åˆ°æŒ‡å®šç›®å½•

    ```shell
    #æ¨¡å‹ä¸‹è½½
    from modelscope import snapshot_download
    # æ³¨æ„æ›¿æ¢æ¨¡å‹åç§°ï¼Œä¸æŒ‡å®šç›®å½•ï¼Œåˆ™é»˜è®¤ä¸‹è½½åˆ°ç”¨æˆ·ç›®å½•.cache/modelscope/
    model_dir = snapshot_download('qwen/Qwen2.5-72B-Instruct-GPTQ-Int8', cache_dir='/data/models/')
    ```


# æ¨¡å‹éƒ¨ç½²


## LLMã€Embeddingã€Rerank dockeréƒ¨ç½²

1. å®‰è£…dockerï¼Œå›½å†…ä½¿ç”¨[æ¸…åå¼€æºè½¯ä»¶é•œåƒç«™](https://mirror.tuna.tsinghua.edu.cn/help/docker-ce/)
2. [å®‰è£…](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html)[**NVIDIA Container Toolkit**](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html)
3. ä½¿ç”¨docker compose éƒ¨ç½²ï¼Œéƒ¨ç½²æ–‡ä»¶è§ä¸‹é¢çš„githubåœ°å€

    [bookmark](https://github.com/bluechanel/deploy_llm/tree/main)

4. clone é¡¹ç›®

    ```json
    git clone git@github.com:bluechanel/deploy_llm.git
    cd deploy_llm
    ```

5. ä¿®æ”¹æ¨¡å‹ä¿å­˜ç›®å½•

    ```yaml
    x-vllm-common:
      &common
      image: vllm/vllm-openai:latest
      restart: unless-stopped
      environment:
        TZ: "Asia/Shanghai"
      volumes:
        - /data/models:/models # æ­¤å¤„ä¿®æ”¹ä¸ºå®é™…æ¨¡å‹ç›®å½•ã€‚
      networks:
        - vllm
    ```

6. ä¿®æ”¹æ¨¡å‹å¯åŠ¨å‚æ•°

    vllmçš„æ›´å¤šå‚æ•°è§[vllmæ–‡æ¡£](https://docs.vllm.ai/en/stable/serving/openai_compatible_server.html#cli-reference)

    1. LLM

        ä¿®æ”¹command é‡Œé¢çš„ `â€”-model` åé¢çš„æ¨¡å‹ç›®å½•ï¼Œæ˜ å°„åˆ°dockerä¸­çš„ç›®å½•


        ```yaml
        command: [ "--model","/models/{ä½ çš„æ¨¡å‹ç›®å½•}",  "--enable-prefix-caching","--host", "0.0.0.0", "--port", "8000", "--served-model-name", "gpt-4", "--distributed-executor-backend","ray","--tensor-parallel-size","2","--pipeline-parallel-size", "1","--enable-reasoning","--reasoning-parser","deepseek_r1"]
        ```


        è¿™é‡Œæœ‰å‡ ä¸ªå¸¸ç”¨å‚æ•°è¯´æ˜


        `--served-model-name`ï¼šæ¨¡å‹è°ƒç”¨åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰å¡«å†™ä»»æ„åç§°


        `--tensor-parallel-size`ï¼šå¹¶è¡Œæ•°é‡ï¼Œå–å†³äºä½¿ç”¨çš„æ˜¾å¡æ•°é‡
        `--enable-prefix-caching`ï¼šå¼€å¯å‰ç¼€ç¼“å­˜ï¼Œå¯¹å¤šè½®å¯¹è¯æœ‰ä¸€å®šæ•ˆç‡æå‡


        `"--enable-reasoning", "--reasoning-parser","deepseek_r1"` å¦‚æœæ˜¯æ¨ç†æ¨¡å‹ï¼Œå¯ä»¥é…ç½®è¯¥å‚æ•°ï¼Œç›®å‰æ”¯æŒ`deepseek_r1`ç³»åˆ—


        `"--enable-auto-tool-choice", "--tool-call-parser", "hermesâ€`ï¼šå¼€å¯å·¥å…·è°ƒç”¨èƒ½åŠ›ï¼Œä¾‹å¦‚Qwen2.5 ç³»åˆ—æ¨¡å‹ï¼Œå‚è€ƒ


        ```yaml
        command: [ "--model","/models/qwen/Qwen2___5-72B-Instruct-GPTQ-Int8", "--enable-prefix-caching", "--host", "0.0.0.0", "--port", "8000", "--served-model-name", "gpt-4", "--enable-auto-tool-choice", "--tool-call-parser", "hermes","--distributed-executor-backend","ray","--tensor-parallel-size","2","--pipeline-parallel-size", "1" ]
        ```

    2. Embedding

        ä¿®æ”¹command é‡Œé¢çš„ `â€”-model` åé¢çš„æ¨¡å‹ç›®å½•ä¸ºæ˜ å°„åˆ°dockerä¸­çš„embeddingæ¨¡å‹ç›®å½•


        ```yaml
        command: [ "--model","/models/{ä½ çš„æ¨¡å‹ç›®å½•}",  "--host", "0.0.0.0", "--port", "8000", "--task", "embed", "--served-model-name", "gte-large-zh"]
        ```

    3. Rerank

        ä¿®æ”¹command é‡Œé¢çš„ `â€”-model` åé¢çš„æ¨¡å‹ç›®å½•ä¸ºæ˜ å°„åˆ°dockerä¸­çš„rerankeræ¨¡å‹ç›®å½•


        ```yaml
        command: [ "--model","/models/{ä½ çš„æ¨¡å‹ç›®å½•}",  "--host", "0.0.0.0", "--port", "8000", "--task", "score", "--served-model-name", "bge-reranker-base"]
        ```

7. ä½¿ç”¨docker compose å¯åŠ¨æ¨¡å‹

    ```json
    docker compose up -d
    ```


    æ¨¡å‹å¯åŠ¨åï¼Œdockerå¯¹å¤–æš´éœ²åœ¨8000ç«¯å£ï¼Œè®¿é—®`http://ip:8000/docs`æŸ¥çœ‹æ¥å£æ–‡æ¡£

8. æµ‹è¯•ï¼Œä½¿ç”¨demoè„šæœ¬æµ‹è¯•ã€‚æ³¨æ„ä¿®æ”¹ å„æ¨¡å‹çš„è‡ªå®šä¹‰åç§°

    ```json
    python demo.py
    ```


## LLMã€embeddingã€rerankeråˆ†ä½“éƒ¨ç½²

# LLMéƒ¨ç½²

1. clone é¡¹ç›®ï¼Œå¹¶è¿›å…¥llmç›®å½•

    ```shell
    git clone https://github.com/bluechanel/deploy_llm.git
    cd deploy_llm/llm
    ```

2. ä¿®æ”¹æ¨¡å‹æ˜ å°„è·¯å¾„ï¼Œ`vim docker-compose.yaml`

    ```shell
    x-common:
      &common
      volumes:
      # ä¿®æ”¹ä¸ºè‡ªå·±ä¸‹è½½æ¨¡å‹çš„åœ°å€æ˜ å°„åˆ°å®¹å™¨/models
        - 
    /data/models:/models
    
      environment:
      # æ—¶åŒºè®¾ç½®
        &common-env
        TZ: "Asia/Shanghai"
    ```


    ä¿®æ”¹æ¨¡å‹å¯åŠ¨å‘½ä»¤ï¼Œåœ¨vllmæœåŠ¡ä¸­ï¼Œä¿®æ”¹`--served-model-name` ä¸ºè‡ªå®šä¹‰æ¨¡å‹åç§°   `--model`ä¸ºä¿®æ”¹åçš„æ¨¡å‹è·¯å¾„ï¼Œ`--tensor-parallel-size 4`ä¸ºä½¿ç”¨æ˜¾å¡æ•°é‡ï¼Œæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹


    ```shell
    command: [ "--model","/models/qwen/Qwen2___5-72B-Instruct-GPTQ-Int8",  "--host", "0.0.0.0", "--port", "8000", "--served-model-name", "gpt-4", "--enable-auto-tool-choice", "--tool-call-parser", "hermes","--distributed-executor-backend","ray","--tensor-parallel-size","4","--pipeline-parallel-size", "1" ]
    ```

3. å¯åŠ¨`docker compose up -d`
4. æŸ¥çœ‹apiæ–‡æ¡£`http://ip:1281/docs`

## Embedding+Rerankéƒ¨ç½²


> ğŸ’¡ embedding å’Œ rerankæ˜¯ä¸¤ä¸ªæ¨¡å‹ï¼Œå¯ç›´æ¥åœ¨modelscopeæœç´¢rerankæ‰¾ç›¸å…³æ¨¡å‹

1. è¿›å…¥embeddingç›®å½•
2. ä¿®æ”¹æ¨¡å‹æ˜ å°„è·¯å¾„ï¼Œ`vim docker-compose.yaml`

    ```shell
    x-common:
      &common
      volumes:
      # ä¿®æ”¹ä¸ºè‡ªå·±ä¸‹è½½æ¨¡å‹çš„åœ°å€æ˜ å°„åˆ°å®¹å™¨/models
        - 
    /data/models:/models
    
      environment:
      # æ—¶åŒºè®¾ç½®
        &common-env
        TZ: "Asia/Shanghai"
    ```


    ä¿®æ”¹embeddingå¯åŠ¨å‘½ä»¤ï¼Œä¿®æ”¹`--model-id`ä¸ºä¿®æ”¹åçš„æ¨¡å‹è·¯å¾„


    ```shell
    command: [ "--json-output", "--model-id", "/models/maple77/gte-large-zh"]
    ```

3. å¯åŠ¨`docker compose up -d`
4. æŸ¥çœ‹apiæ–‡æ¡£embedding: `http://ip:1282/docs` rerank:`http://ip:1283/docs`

    ![Untitled.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/da864e11-683f-4c2d-a264-16ecdf57fff9/e1756aaa-6b65-4e54-a5fe-aa2bba18033b/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB4664XGYG6JB%2F20250707%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250707T081158Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEGUaCXVzLXdlc3QtMiJGMEQCIHBa1dnd5ConTsKjHWZBo5eyz%2F%2B6KQnabYNv%2BROmxv%2FvAiB9yJo4oR%2FF1ZqhTsnXZ8Wg1e%2BbflhVLz3zBv2idV3LGyr%2FAwhuEAAaDDYzNzQyMzE4MzgwNSIMfWVH%2BjOfp7gjmCWlKtwDu%2FqYSE9W5XJWNMu2wdf5chd7IBz83Aui6rDf9xNEau2lpYMhDUK7BhWjyTCIACLbSdqblMTiGqO3XYZTaiUDYeQUf3cYRWnGBNjJ8EL%2Bnd1DdKET9LLBlfevyy3S%2BVizivKvVWss1HmVYp24icS1qxR3M%2BQ1rRj27mCSR0WIvN4f7l3557GumPLNHI8PmhNai9LSvTpjZHWiapStXUIl%2FsVQx7RONAVa%2B14frDTDJEnNno8jul4szI%2Fkrxe83b89tnP61tP76KKioj7QoKlsEUv5tf8N%2FBnrY9%2F2a0EU1iis8e1m1V%2B695xDlE4TfrYb5PPdP%2FBCURYWnktwjCS9p0flpYyK0WuM18%2FUrCyeAC3hBeVN%2F0Sxkr9OpaSDy%2BaF9TrCM%2F%2BqIPaxTSrL0R1N4a%2B%2FXSf94h47DiRQmt06FmudacdTjMoNMZh91GLYPxcSMtgHQ5h6oIzJW9R3%2FRBnBTRBCOnXvCw8MIN%2Bj4fqZSc1MYGB8b303uuVfrvLWyKk6j5vRdeJlmVzlSInF%2Bk4FMd0nB8W%2BxSh%2BKKPs%2BY30wP3K7OZ%2FRy96EV4hs1i2D9cb65%2FWIcmgZM8LPL8tuDgfk8crvBrKp%2Bh%2BBg%2BeuQVSloXcFq2FTi19xQqFpMw16atwwY6pgEKOi7v8gnvrBgdqnM8mMthZodwV3yR0Ov1oTE%2BD37ZK9vJwGLbKxDkLi1ZSDatYpKUE68Rcteld5UXAWzwocfnv2kJSLjImIt%2Fb29aFkLi5M3m74QZepnAMBdEbgemHomv9iyR1s%2FDOVtC7WM1MAizKw0WzWB0eQdcLaAOG4vctRO7P8QDFRiiegiLtSLuqq5b8mD5R3tmBirOY1WsB1AWXL6rXS8H&X-Amz-Signature=d6f304e4e83f190d9a9107eea505abacef1d4fa7522dc2bcf2c140c5e4cf5c9b&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)


**æ’é”™**


vllmå¯åŠ¨å¯èƒ½ä¼šæœ‰å¦‚ä¸‹æŠ¥é”™ï¼Œåœ¨docker composeä¸­ä¿®æ”¹`shm_size`çš„å€¼ä¸ºé”™è¯¯æç¤ºçš„å€¼ï¼Œå³å¯


![Untitled.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/da864e11-683f-4c2d-a264-16ecdf57fff9/bae86682-7725-440f-a248-074de305b696/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466RJJVUKSV%2F20250707%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250707T081156Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEGUaCXVzLXdlc3QtMiJHMEUCIFKrtFWHFsRZTO3SqZzDfwI0FTyt73rnAngQpgpo2BocAiEA3MJKU7x55ExjKMsOkvnHV4UbwlYMdnGM7YM2VuEjoLYq%2FwMIbhAAGgw2Mzc0MjMxODM4MDUiDCGzPpNOHvyLjpIY0yrcA3OJOEUvHHtom%2FmWVO3sDWryL3Ozby5VagseTbF9zBYyFnn%2Ff%2FQ00dTpqrtv5f25fd8bO2TnwgFl2LcXmpkDpDvLssDDlpTP6vZCDZv8CisWxkEYi8EtCNoWz87uVfyJktcnTi%2FzhnYFbN6aSnatMqb136VgNIlQ%2BYVBK6UXo6ZlPQ5C%2FY4hQ4M2QDrfPyJFg6txBsoCe2XlHyyyQ5N3HECKw0V0ClA%2BhFDLB7DGeDGPpdqFvZUW18zU4SZTnMApxy45VN5Dwtehto5TmosKn8GUunnFJapnJPXPRDj0r75BO6jV4KW70KTCRIZpMyFGJSGelgpBGdyjfNcxNQo3VFPZqYV6QDTv%2FNhaTcDbpEnZ0eAlgSoldgqlLXE5N5%2FqiOpqWz4ApcHA6sAFgp3vJnHeuMWb5wyIYHv0CzKzFR2sMHuXVF%2BnPCIHdGtcFIv%2BTPSJVCZ4G0YgkZxLkcgwS2CXrPDlqtwOuWFbo2ziuOg6t1O2wQNp1q6P7dFe22bd84ze9xj3%2FNuC5F9QOz5UGKe33SWhyULpHanZal%2FG8BRtFP84xkfYoL0Lqp3GdS1%2FoleIz7iWmypMZAkI8GSQbulijPpq4WeAsrDs2OeZXUitOpBKonPkt7BxtPuVMKWtrcMGOqUBThagEs3HnGtcMYIjos5Lt2L0DWmTp8GEUmSDJCTIfA4%2BiXhhaW5%2FXxnl2ugPmxqXcREaCaHJPUaJoLBMqYUcteCHZFhnA%2BjUfX8ieAx0AuA62FFkL8THMxj89rzO6eiqZwiHD6FjMdiCaAH85Q16LK2oGI9%2Fpi0168D8C8%2FBAlX%2Fdx5kFJH2PnR2gsKFYteXcHLTDOOApvUwKAPTvJLK3Pkgw3tT&X-Amz-Signature=5bb975b5822dd56a42f64a6b736dd2eb06a494613fd698bd719897ec5a30f2d3&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)


## å·²åºŸå¼ƒéƒ¨ç½²æ–¹æ³•ï¼ˆ20240918ï¼‰

# æ¨¡å‹éƒ¨ç½²


å½“å‰å¼€æºçš„æ¨¡å‹éƒ¨ç½²æœåŠ¡å¾ˆå¤šï¼Œä¸»æµçš„æœ‰[FastChatã€](https://github.com/lm-sys/FastChat)[Xinference](https://github.com/xorbitsai/inference)ã€[ollama](https://github.com/ollama/ollama)ã€[vllm](https://github.com/vllm-project/vllm)ã€[lightllm](https://github.com/ModelTC/lightllm)ï¼Œå…¶ä¸­vllmï¼Œlightllmä¸»è¦æ˜¯ç”¨äº**æ¨¡å‹åŠ é€Ÿ**ã€‚åŒæ—¶FastChatç­‰ä¹Ÿæ”¯æŒä½¿ç”¨vllmå¯åŠ¨æ¨¡å‹è·å¾—é«˜æ•ˆåŠ é€Ÿï¼Œä¸è¿‡è¿™äº›éƒ¨ç½²æœåŠ¡éƒ½**ä¸æ”¯æŒå·¥å…·è°ƒç”¨**ï¼Œä¹Ÿå°±æ˜¯OpenAI æ¥å£çš„toolså‚æ•°ã€‚é‚æˆ‘å¯¹FastChatçš„ä»£ç åšäº†éƒ¨åˆ†ä¿®æ”¹ï¼Œä½¿å…¶**æ”¯æŒtoolså‚æ•°ã€‚**å…·ä½“ä»£ç è§githubï¼Œï¼ˆä»…æµ‹è¯•äº†Qwenç³»åˆ—ï¼‰


> ğŸ’¡ ç”±äºä¸åŒæ¨¡å‹è®­ç»ƒæ•°æ®ä¸åŒï¼ŒåŒæ ·çš„Promptåœ¨ä¸åŒçš„æ¨¡å‹ä¸­ç»“æœå·®å¼‚è¾ƒå¤§ï¼Œå¯¼è‡´toolsèƒ½åŠ›ä¸ç¨³å®šï¼Œè¯¥èƒ½åŠ›æœªæäº¤FastChatåŸå§‹ä»“åº“ã€‚


[bookmark](https://github.com/bluechanel/FastChat/tree/main)


æ¨èçš„éƒ¨ç½²æ–¹æ¡ˆä¸ºï¼šFastChat+vllm


## æ–¹æ¡ˆ1ï¼šdockeréƒ¨ç½²(æ¨è)

1. å®‰è£…dockerï¼Œå›½å†…ä½¿ç”¨[æ¸…åå¼€æºè½¯ä»¶é•œåƒç«™](https://mirror.tuna.tsinghua.edu.cn/help/docker-ce/)
2. [å®‰è£…](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html)[**NVIDIA Container Toolkit**](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html)
3. ä½¿ç”¨docker compose éƒ¨ç½²ï¼Œéƒ¨ç½²æ–‡ä»¶è§ä¸‹é¢çš„githubåœ°å€

    [bookmark](https://github.com/bluechanel/deploy_llm/tree/main)


### LLMéƒ¨ç½²

1. clone é¡¹ç›®ï¼Œå¹¶è¿›å…¥llmç›®å½•

    ```shell
    git clone https://github.com/bluechanel/deploy_llm.git
    cd deploy_llm/llm
    ```

2. ä¿®æ”¹æ¨¡å‹æ˜ å°„è·¯å¾„ï¼Œ`vim docker-compose.yaml`

    ```shell
    x-common:
      &common
      volumes:
      # ä¿®æ”¹ä¸ºè‡ªå·±ä¸‹è½½æ¨¡å‹çš„åœ°å€æ˜ å°„åˆ°å®¹å™¨/models
        - 
    /data/models:/models
    
      environment:
      # æ—¶åŒºè®¾ç½®
        &common-env
        TZ: "Asia/Shanghai"
    ```


    ä¿®æ”¹æ¨¡å‹å¯åŠ¨å‘½ä»¤ï¼Œåœ¨`fastchat-model-worker`æœåŠ¡ä¸­ï¼Œä¿®æ”¹`--model-names` ä¸ºè‡ªå®šä¹‰æ¨¡å‹åç§°   `--model-path`ä¸ºä¿®æ”¹åçš„æ¨¡å‹è·¯å¾„ï¼Œ`"--num-gpus", "4"`ä¸ºä½¿ç”¨æ˜¾å¡æ•°é‡ï¼Œæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹


    ```shell
    entrypoint: [ "python3", "-m", "fastchat.serve.vllm_worker", "--model-names", "gpt-4", "--model-path", "/models/qwen/Qwen2-72B-Instruct-GPTQ-Int8", "--worker-address", "http://fastchat-model-worker:21002", "--controller-address", "http://fastchat-controller:21001", "--host", "0.0.0.0", "--port", "21002", "--num-gpus", "4" ]
    ```

3. å¯åŠ¨`docker compose up -d`

    **æ³¨æ„:**


    æ­¤ç‰ˆæœ¬Apiæ¥å£ä½¿ç”¨çš„æ˜¯æ”¯æŒ**å·¥å…·è°ƒç”¨**çš„ï¼Œå¦‚æœä¸éœ€è¦ï¼Œè¯·ä¿®æ”¹`docker-compose.yaml`æ–‡ä»¶ä¸­`fastchat-api-server`çš„å¯åŠ¨å‘½ä»¤ä¸º


    ```shell
    entrypoint: [ "python3", "-m", "fastchat.serve.openai_api_server", "--controller-address", "http://fastchat-controller:21001", "--host", "0.0.0.0", "--port", "8000" ]
    ```

4. æŸ¥çœ‹apiæ–‡æ¡£`http://ip:1281/docs`

    ![Untitled.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/da864e11-683f-4c2d-a264-16ecdf57fff9/5813f5f8-9f74-497d-a7d3-ff6317a1e549/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466VVXEVI4I%2F20250707%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250707T081200Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEGUaCXVzLXdlc3QtMiJHMEUCIQDox%2BOrWyuzoJw7heXkR4ssRm6yFSCEQiLcZ6DkjgLRNAIgPc%2BaT%2F31vcEDG4UAX0b%2F1Q4LgQVUGTbW4IFGGnFApI4q%2FwMIbhAAGgw2Mzc0MjMxODM4MDUiDIt9jrSq3FIympcY3ircA8Sy0D3bd9PynmiFQOZLPI8IYWajLP9kSueyVqLgsUZpb2CimgOFmpAFNzEj4%2FI3zLEWqI%2BK90leltW0hLPWoyh%2FTqYIkn69iCmkXpLODiKvmPVKohaRWtQSOHukxQ29TeI10rCoFWCUySQtb6go3DsHZr6MZh%2FBMqNA2%2FJcY%2BVmdXK6Ugol2Lb9yjJXDH%2BVudtQcODRbEOy058SFyU6otibo53S%2FMAqCc8XY%2BIopBzLMvun84P3VS5fN9qR3EPu0%2BlYnDfAuQ%2F7scxaI6DpdQPIjeChvTZblr%2FEfWCUcJyeiWuoS29kP%2BI2huId%2BZnd2q3vGSf6YTHE4BlBEpvcyDXBURT5phUSj2yWZjBli1wrqZB6jDhugELi3P5qP7jq59C3Hz673z%2FBF3Ocj5hgxQoEuVDJCvXu8E49Dl8CDQgZ1ryNNqD1ci18VEee8CNY3yEQkB%2Fuv6ImglWtA3minJwg%2F%2Fv%2FrK1bgi8Qg5nXm4Apyrg%2BzB01Ax5TRf47n7SFfaKOTF1wsFy5yG%2FaOsmlvfynUvKUWcTVLgpeUwMAPY9wDnwC21V1s4p2lQgHSpsEcO1bZwgOAbZlxQKl0pjojR9KLd1otgJSovgBht0s4WFrSvnQSMW3ZJ5aEQwxMIyrrcMGOqUBtB3Zxl0vTt6XONUnmoiPCEkGk9Z6oy0ZwqcHn1WiOhqbKB7SQUw0zkkHo0OCZOr%2F2sXZxSiQ%2BZwbfCMty8j%2FKPctq42sfuWgh1xYDnUtc59uOmip6Be%2Fjn8OKIz47C6RnNLXq5jADlO4ViVosG1h8DZjBfVbk7gq%2FmUKtlaaIHpBuJ2byFVMHn%2Bw3dHOHP8dMGtbfQnfDc3sILGNMU%2Bt5iqy9S1R&X-Amz-Signature=4bed047e8776d25ed8a6eac27e709b4ee3f9738e48c2d17a6a62ebcfd18b342b&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)


## æ–¹æ¡ˆ2ï¼šæœ¬åœ°ç¯å¢ƒéƒ¨ç½²


ä½¿ç”¨fastchatåŠ è½½æ¨¡å‹ï¼ˆ[æ”¯æŒæ¨¡å‹](https://github.com/lm-sys/FastChat/blob/main/docs/model_support.md)ï¼‰ï¼Œç”±äºLLMéƒ½æ˜¯ç”±transformerså¼€å‘ï¼Œç†è®ºä¸Šfschatå¯ä»¥ç”¨äºå¯åŠ¨æ‰€æœ‰LLM


[link_preview](https://github.com/lm-sys/FastChat)


```python
conda create -n fschat python=3.10

pip install fschat
```


å‘½ä»¤è¡Œå¯åŠ¨


```python
conda activate fschat
python -m fastchat.serve.cli --model-path /data/models/qwen/Qwen-14B-Chat
```


openaiæ¥å£æ–¹å¼å¯åŠ¨


```python
conda activate fschat
python -m fastchat.serve.controller
python -m fastchat.serve.model_worker --model-path /data/models/qwen/Qwen-14B-Chat
# æ­¤å¤„ä¹Ÿå¯æ›¿æ¢ä¸ºä½¿ç”¨vllm worker
# python -m fastchat.serve.vllm_worker --model-path /data/models/qwen/Qwen-14B-Chat
python -m fastchat.serve.openai_api_server --host 0.0.0.0 --port 1282
```


### supervisor ç®¡ç†


```python
# ç”±äºå¯åŠ¨é¡¹è¾ƒå¤šï¼Œæˆ‘ä»¬ä½¿ç”¨supervisorç®¡ç†
pip install supervisor
```


supervisor é…ç½®æ–‡ä»¶`supervisord.conf`å¢åŠ å¦‚ä¸‹å†…å®¹ï¼Œå¹¶åˆ›å»ºæ–‡ä»¶å¤¹`/data/supervisor/conf.d`


```python
[include]
files = /data/supervisor/conf.d/*.conf
```


åœ¨`/data/supervisor/conf.d`ä¸­åˆ›å»º`llm.conf`,å†™å…¥å¦‚ä¸‹å†…å®¹, é‡ç‚¹æ˜¯llm_modelçš„å¯åŠ¨å‚æ•°ï¼Œmodel_pathç”¨äºæŒ‡å®šæ¨¡å‹æ–‡ä»¶çš„åœ°å€ï¼Œå¯¹äºå¤šGPUï¼Œæ·»åŠ å‚æ•°`--num-gpus 4 --max-gpu-memory "80GiB"`


```python
[program:llm_ctrl]
command=/home/jx/anaconda3/envs/fschat/bin/python3 -m fastchat.serve.controller
stdout_logfile=/data/supervisor/logs/ctrl.log

[program:llm_model]
command=/home/jx/anaconda3/envs/fschat/bin/python3 -m fastchat.serve.model_worker --model-path /data/models/qwen/Qwen-14B-Chat --num-gpus 4 --max-gpu-memory "80GiB"
stdout_logfile=/data/supervisor/logs/model.log

[program:llm_api]
command=/home/jx/anaconda3/envs/fschat/bin/python3 -m fastchat.serve.openai_api_server --host 0.0.0.0 --port 1282
stdout_logfile=/data/supervisor/logs/api.log
```


# æ¨¡å‹ä½¿ç”¨


åœ¨langchianä¸­å¥—å£³ChatOpenAIä½¿ç”¨ï¼Œæˆ–ç›´æ¥ä½¿ç”¨OpenAI SDKï¼Œå¯å‚è€ƒdemo.py


### LLM


**æ–¹å¼1**


```shell
from langchain_openai import ChatOpenAI
from langchain_core.pydantic_v1 import SecretStr

class MyChat(ChatOpenAI):
    openai_api_base = "http://ip:1282/v1"
    openai_api_key = SecretStr("123456")
    model_name = "Qwen-14B-Chat"
    max_tokens = 1024# ä¾æ®ä¸åŒæ¨¡å‹æ”¯æŒçš„é•¿åº¦è¿›è¡Œè°ƒæ•´

llm=MyChat(temperature=0)
```


**æ–¹å¼2**


```python
os.environ.setdefault("OPENAI_API_KEY", "12123123")
os.environ.setdefault("OPENAI_API_BASE", "http://ip:1282/v1")
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(model_name="Qwen-14B-Chat")
```


### Embedding


```shell
from langchain_openai import OpenAIEmbeddings
from pydantic.v1 import SecretStr


class TaliAPIEmbeddings(OpenAIEmbeddings):
    openai_api_base = "http://ip:1281/v1"
    openai_api_key = SecretStr("123456")
    check_embedding_ctx_length = False
```


# æ¨¡å‹åŠ é€Ÿ

1. [vllm](https://github.com/vllm-project/vllm)
2. [flash-attention](https://github.com/Dao-AILab/flash-attention)

    å®‰è£…é‡åˆ°çš„é—®é¢˜ï¼š

    1. OSError: CUDA_HOME environment variable is not set. Please set it to your CUDA install root.

        æŒ‡å®šcuda homeåœ°å€


        `CUDA_HOME=/usr/local/cuda-11.8 python` [`setup.py`](http://setup.py/) `install`or`CUDA_HOME=/usr/local/cuda-11.8 pip install flash-attn --no-build-isolation`

