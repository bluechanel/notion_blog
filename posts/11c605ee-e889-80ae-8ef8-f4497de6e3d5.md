---
id: 11c605ee-e889-80ae-8ef8-f4497de6e3d5
title: ğŸš å‘é‡/æ··åˆæ£€ç´¢-Elasticsearch
slug: 11c605ee-e889-80ae-8ef8-f4497de6e3d5
excerpt: ä»‹ç»ESçš„dockeréƒ¨ç½²ï¼Œä»¥åŠåœ¨RAGåº”ç”¨ä¸­ï¼Œå‘é‡å’Œæ··åˆæ£€ç´¢çš„ä½¿ç”¨
date: Fri Oct 11 2024 08:00:00 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)
coverImage: /images/11c605ee-e889-80ae-8ef8-f4497de6e3d5_26b46fb1baae0d581df27ab37a57b445.png
lastUpdated: Thu Oct 24 2024 16:10:00 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)
tags: blue:RAG,purple:Vector Store
readTime: 2.315
---

# ESæœ¬åœ°éƒ¨ç½²


[å®˜æ–¹éƒ¨ç½²æ‰‹å†Œ](https://www.elastic.co/guide/en/elasticsearch/reference/8.15/docker.html)


è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å®˜æ–¹çš„`docker-compose`æ–‡ä»¶éƒ¨ç½²


[bookmark](https://github.com/elastic/elasticsearch/tree/8.15/docs/reference/setup/install/docker)


> ğŸ’¡ æ³¨æ„ä¿®æ”¹.envæ–‡ä»¶ä¸­çš„å¯†ç ä¿¡æ¯


# ä½¿ç”¨

1. ä½¿ç”¨eså®¢æˆ·ç«¯è¿›è¡Œè¿æ¥

    ```python
    es_connection = Elasticsearch("http://127.0.0.1:9200", basic_auth=("elastic", "xxxxxx"))
    ```


    > ğŸ’¡ ES pythonå®¢æˆ·ç«¯æ›´å¤šè¿æ¥æ–¹å¼ï¼Œè§ä¸‹é¢çš„å®˜æ–¹æ–‡æ¡£  
    > [bookmark](https://www.elastic.co/guide/en/elasticsearch/client/python-api/current/connecting.html#connect-self-managed-new)

2. å‘é‡æ£€ç´¢

    ```python
    vector = [0.1,0.1,0.1]
    query_body = {
            "query": {"knn": {"field": "vector", "query_vector": vector, "k": 3}},
            "_source": ["text", "metadata"],
            "size": 3,
      }
    es_response = es_connection .search(
        index=index_name, body=query_body
    )
    ```


    æ›´å¤šå†…å®¹è§[å®˜æ–¹æ–‡æ¡£](https://www.elastic.co/guide/en/elasticsearch/reference/8.15/knn-search.html)

3. æ··åˆæ£€ç´¢

    æ··åˆæ£€ç´¢æŒ‡ **ç¨ å¯†å‘é‡+ç¨€ç–å‘é‡**ï¼Œå› æ­¤ï¼Œæ··åˆæ£€ç´¢åè¦ä½¿ç”¨Rerankè¿›è¡Œé‡æ’ã€‚


    Rerankç­–ç•¥æœ‰ä¸‰ç§ï¼š

    - åŠ æƒè¯„åˆ†
    - RRFï¼ˆäº’æƒ æ’åºèåˆï¼‰
    - ä½¿ç”¨Rerankæ¨¡å‹

    ES[å®˜æ–¹](https://www.elastic.co/guide/en/elasticsearch/reference/current/retriever.html#rrf-retriever)æä¾›äº†RRFé‡æ–°è®¡ç®—è¯„åˆ†ï¼Œä¸è¿‡è¯¥åŠŸèƒ½å¹¶ä¸åœ¨è‡ªç®¡å‹ESä¸­æä¾›ï¼Œä½¿ç”¨ä¼šæç¤ºlicenseä¸æ”¯æŒã€‚æœªç»å°è¯•ã€‚


    è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ„å»º å‘é‡æ£€ç´¢ï¼ˆç¨ å¯†å‘é‡ï¼‰+å…¨æ–‡æ£€ç´¢ï¼ˆESçš„å…¨æ–‡æ£€ç´¢è‡ª5.0åæ¨¡å‹é‡‡ç”¨BM25è®¡ç®—ç›¸ä¼¼æ€§ï¼‰çš„ESæŸ¥è¯¢ä½“ï¼Œç„¶åå†ä½¿ç”¨**Rerankæ¨¡å‹**è¿›è¡Œé‡æ’


    ```python
    # ES æŸ¥è¯¢ä½“
    queries = ["CADæ–¹æ³•", "CADæ˜¯ä»€ä¹ˆ","CADæœ‰å“ªäº›æ–¹æ³•"]
    vectors = await embeddings.aembed_documents(texts=queries)
    bm = [{"match": {"text": {"query": text, "boost": 1}}} for text in queries]
    
    knn = [
        {"knn": {"field": "vector", "query_vector": vector, "k": 3, "boost": 1000}}
        for vector in vectors
    ]
    body =  {
        "query": {"bool": {"should": bm + knn}},
        "_source": ["text", "metadata"],
        "size": 6 * len(queries),
    }
    es_response = es_connection .search(
        index=index_name, body=body
    )
    ```


    å‘é‡æ£€ç´¢(KNN) çš„å¾—åˆ†èŒƒå›´ä¸º0-1ï¼Œå…¨æ–‡æ£€ç´¢å¾—åˆ†èŒƒå›´æ ¹æ®å‘½ä¸­çš„å…³é”®è¯å¯èƒ½æ— é™å¤§ã€‚ä¸ºäº†ä½¿knnæ£€ç´¢çš„ç»“æœå°½å¯èƒ½çš„åŒ…æ‹¬åœ¨è¿”å›ç»“æœä¸­ï¼Œè°ƒæ•´KNNæŸ¥è¯¢çš„çš„boostä¸º1000ï¼ŒåŸå§‹å¾—åˆ†*1000ã€‚(è¯¥æ–¹æ³•å­˜åœ¨é—®é¢˜ï¼Œå¾…ç ”ç©¶)


    > ğŸ’¡ å…³äºRerankæ¨¡å‹éƒ¨ç½²å‚è€ƒ[https://www.wileyzhang.com/llméƒ¨ç½²dockervllmembeddingrerank-æ”¯æŒå·¥å…·è°ƒç”¨](https://www.wileyzhang.com/llm%E9%83%A8%E7%BD%B2dockervllmembeddingrerank-%E6%94%AF%E6%8C%81%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8)

