---
id: efa53000-b650-4171-804f-d2d7261ab846
title: ğŸ³ K8S+Rancheræ­å»º
slug: efa53000-b650-4171-804f-d2d7261ab846
excerpt: K8S æ­å»º
date: 2023-04-01
coverImage: /images/efa53000-b650-4171-804f-d2d7261ab846_2ddf433760e1dc69781e5d191b17121b.png
lastUpdated: 2024-06-15T05:56:00.000Z
tags: blue:K8S,brown:Rancher  
---

# å®‰è£…K8S

1. ä¿®æ”¹ä¸»æœºå

    ```shell
    hostnamectl set-hostname kubemaster
    echo 172.16.0.22 kubemaster >> /etc/hostsg
    ```

2. å…³é—­selinux

    ```shell
    setenforce 0
    sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
    ```

3. è½¬å‘ IPv4 å¹¶è®© iptables çœ‹åˆ°æ¡¥æ¥æµé‡[æ–‡æ¡£](https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/)

    ```shell
    cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
    overlay
    br_netfilter
    EOF
    
    sudo modprobe overlay
    sudo modprobe br_netfilter
    
    # è®¾ç½®æ‰€éœ€çš„ sysctl å‚æ•°ï¼Œå‚æ•°åœ¨é‡æ–°å¯åŠ¨åä¿æŒä¸å˜
    cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-iptables  = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    net.ipv4.ip_forward                 = 1
    EOF
    
    # åº”ç”¨ sysctl å‚æ•°è€Œä¸é‡æ–°å¯åŠ¨
    sudo sysctl --system
    ```

4. å…³é—­äº¤æ¢åŒº

    ```shell
    swapoff -a
    sed -e '/swap/s/^/#/g' -i /etc/fstab
    ```

5. å®‰è£…å®¹å™¨

    ä½¿ç”¨containerdï¼Œå¹¶ä¿®æ”¹é…ç½®


    ```sql
    dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
    dnf install -y containerd.io
    
    mv /etc/containerd/config.toml /etc/containerd/config.toml.orig
    containerd config default > /etc/containerd/config.toml
    # æ‰“å¼€æ–‡ä»¶ ä¿®æ”¹SystemdCgroupä¸ºtrue
    vi /etc/containerd/config.toml
    [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
        SystemdCgroup = true
    # é…ç½®å¼€æœºå¯åŠ¨ï¼ŒæŸ¥çœ‹çŠ¶æ€
    systemctl enable --now containerd.service
    systemctl status containerd.service
    ```


    ä½¿ç”¨docker


    ```shell
    dnf install -u docker-ce
    systemctl enable -now docker
    systemctl status docker
    VER=$(curl -s https://api.github.com/repos/Mirantis/cri-dockerd/releases/latest|grep tag_name | cut -d '"' -f 4|sed 's/v//g')
    echo $VER
    wget https://github.com/Mirantis/cri-dockerd/releases/download/v${VER}/cri-dockerd-${VER}.amd64.tgz
    tar xvf cri-dockerd-${VER}.amd64.tgz
    mv cri-dockerd/cri-dockerd /usr/local/bin/
    wget https://raw.githubusercontent.com/Mirantis/cri-dockerd/master/packaging/systemd/cri-docker.service
    wget https://raw.githubusercontent.com/Mirantis/cri-dockerd/master/packaging/systemd/cri-docker.socket
    sudo mv cri-docker.socket cri-docker.service /etc/systemd/system/
    sudo sed -i -e 's,/usr/bin/cri-dockerd,/usr/local/bin/cri-dockerd,' /etc/systemd/system/cri-docker.service
    sudo systemctl daemon-reload
    sudo systemctl enable cri-docker.service
    sudo systemctl enable --now cri-docker.socket
    ```

6. é˜²ç«å¢™ç«¯å£å¼€å¯

    ```shell
    firewall-cmd --permanent --add-port={6443,2379,2380,10250,10251,10252}/tcp
    firewall-cmd --reload
    ```

7. é…ç½®k8sé•œåƒæº

    ```shell
    cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
    [kubernetes]
    name=Kubernetes
    baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
    enabled=1
    gpgcheck=1
    gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
    exclude=kubelet kubeadm kubectl
    EOF
    ```

8. å®‰è£…k8sï¼Œå½“å‰ç‰ˆæœ¬ä¸º1.27.1ï¼Œæ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œä¸€èˆ¬ä¸Šä¸€ä¸ªç‰ˆæœ¬1.26.3ä¸ºç¨³å®šç‰ˆæœ¬ã€‚å¦‚æœè¦å®‰è£…rancherï¼Œè¯·å¯¹ç…§rancher[æ”¯æŒçš„ç‰ˆæœ¬](https://artifacthub.io/packages/helm/rancher-stable/rancher#views)

    ```shell
    dnf install -y {kubelet,kubeadm,kubectl} --disableexcludes=kubernetes
    # ä½¿ç”¨ä¸Šä¸€ä¸ªç‰ˆæœ¬
    dnf install -y kubelet-1.26.3 kubeadm-1.26.3 kubectl-1.26.3 --disableexcludes=kubernetes
    systemctl enable --now kubelet.service
    # æ­¤æ—¶æŸ¥çœ‹çŠ¶æ€æ˜¯å¯åŠ¨é”™è¯¯
    systemctl status kubelet.service
    ```

9. å¼€å¯bashè‡ªåŠ¨è¡¥å…¨

    ```shell
    source <(kubectl completion bash)
    kubectl completion bash > /etc/bash_completion.d/kubectl
    ```

10. ä½¿ç”¨é˜¿é‡Œæºä¸‹è½½å®¹å™¨é•œåƒ

    ```shell
    # æŸ¥çœ‹ä¾èµ–é•œåƒçš„ç‰ˆæœ¬ï¼Œåç»­ä¿®é•œåƒtagéœ€è¦ä½¿ç”¨
    kubeadm config images list
    # contrainerdç‰ˆæœ¬
    kubeadm config images pull --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers
    # dockerç‰ˆæœ¬ï¼ŒæŒ‡å®šcrisocketç‰ˆæœ¬
    kubeadm config images pull --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers --cri-socket unix:///var/run/cri-dockerd.sock
    ```

11. ä¿®æ”¹é•œåƒtagï¼Œä¸€å…±7ä¸ªé•œåƒ

    ```shell
    # contrainerdç‰ˆæœ¬
    ctr -n k8s.io image tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9 registry.k8s.io/pause:3.9
    ctr -n k8s.io image tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.10.1 registry.k8s.io/coredns:v1.10.1
    ctr -n k8s.io image tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.7-0 registry.k8s.io/etcd:3.5.7-0
    ctr -n k8s.io image tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.27.1 registry.k8s.io/kube-apiserver:v1.27.1
    ctr -n k8s.io image tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.27.1 registry.k8s.io/kube-controller-manager:v1.27.1
    ctr -n k8s.io image tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.27.1 registry.k8s.io/kube-scheduler:v1.27.1
    ctr -n k8s.io image tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.27.1 registry.k8s.io/kube-proxy:v1.27.1
    # dockerç‰ˆæœ¬ï¼ŒæŒ‡å®šcrisocketç‰ˆæœ¬
    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.26.4 k8s.gcr.io/kube-apiserver:v1.26.4
    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.26.4 k8s.gcr.io/kube-controller-manager:v1.26.4
    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.26.4 k8s.gcr.io/kube-scheduler:v1.26.4
    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.26.4 k8s.gcr.io/kube-proxy:v1.26.4
    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.9.3 k8s.gcr.io/coredns:v1.9.3
    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.6-0 k8s.gcr.io/etcd:3.5.6-0
    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9 k8s.gcr.io/pause:3.9
    
    
    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.26.4
    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.26.4
    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.26.4
    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.26.4
    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.9.3
    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.6-0
    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9
    ```

12. å®‰è£…CNIæ’ä»¶

    containerdç‰ˆ


    ```shell
    mkdir /opt/bin
    curl -fsSLo /opt/bin/flanneld https://github.com/flannel-io/flannel/releases/download/v0.20.1/flannel-v0.20.1-linux-amd64.tar.gz
    chmod +x /opt/bin/flanneld
    ```


    æ·»åŠ [CNIé…ç½®æ–‡ä»¶](https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/migrating-from-dockershim/troubleshooting-cni-plugin-related-errors/#about-the-incompatible-cni-versions-and-failed-to-destroy-network-for-sandbox-errors)


    ```shell
    cat << EOF | tee /etc/cni/net.d/10-containerd-net.conflist
    {
     "cniVersion": "1.0.0",
     "name": "containerd-net",
     "plugins": [
       {
         "type": "bridge",
         "bridge": "cni0",
         "isGateway": true,
         "ipMasq": true,
         "promiscMode": true,
         "ipam": {
           "type": "host-local",
           "ranges": [
             [{
               "subnet": "10.88.0.0/16"
             }],
             [{
               "subnet": "2001:db8:4860::/64"
             }]
           ],
           "routes": [
             { "dst": "0.0.0.0/0" },
             { "dst": "::/0" }
           ]
         }
       },
       {
         "type": "portmap",
         "capabilities": {"portMappings": true},
         "externalSetMarkChain": "KUBE-MARK-MASQ"
       }
     ]
    }
    EOF
    ```


    dockerç‰ˆæœ¬


    ```shell
    vi /etc/systemd/system/cri-docker.service
    # ä¿®æ”¹ä¸‹é¢çš„é…ç½®
    ExecStart=/usr/local/bin/cri-dockerd --network-plugin cni --container-runtime-endpoint fd://
    
    systemctl daemon-reload
    systemctl restart cri-docker
    
    cat << EOF > 01-cri-dockerd.json
    {
      "cniVersion": "0.4.0",
      "name": "dbnet",
      "type": "bridge",
      "bridge": "cni0",
      "ipam": {
        "type": "host-local",
        "subnet": "10.1.0.0/16",
        "gateway": "10.1.0.1"
      }
    }
    EOF
    ```

13. åˆå§‹åŒ–

    ```shell
    kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers
    # dockerç‰ˆæœ¬
    kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers --cri-socket unix:///var/run/cri-dockerd.sock
    ```


    åˆå§‹åŒ–å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—


    é”™è¯¯1ï¼š`failed to pull image \"`[`registry.k8s.io/pause:3.6\`](http://registry.k8s.io/pause:3.6%5C)`": failed to pull and unpack image \"`[`registry.k8s.io/pause:3.6\`](http://registry.k8s.io/pause:3.6%5C)`"`


    åŸå› ï¼šè™½ç„¶å‘½ä»¤è¡Œæä¾›çš„pauseæ˜¯3.9ç‰ˆæœ¬ï¼Œä½†å®é™…åˆå§‹åŒ–è¿‡ç¨‹ä¸­éœ€è¦çš„æ˜¯3.6ç‰ˆæœ¬ï¼Œé»˜è®¤æ˜¯å»googleäº‘è·å–é•œåƒï¼Œå›½å†…æ— æ³•è®¿é—®ï¼Œå¯¼è‡´é”™è¯¯


    è§£å†³æ–¹æ³•ï¼š


    è‡ªè¡Œä¸‹è½½3.6 å¹¶ä¿®æ”¹tag


    ```shell
    # contrainerdç‰ˆæœ¬
    ctr -n k8s.io image pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6
    ctr -n k8s.io image tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6 registry.k8s.io/pause:3.6
    # docker ç‰ˆæœ¬
    docker image pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6
    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6 registry.k8s.io/pause:3.6
    ```


    é‡ç½®åˆå§‹åŒ–`kubeadm reset`åï¼Œé‡æ–°æ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤ï¼ŒæˆåŠŸ


    ![Untitled.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/da864e11-683f-4c2d-a264-16ecdf57fff9/533759da-fae8-40d2-90ca-2b1456c1f0e8/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466SAZKBTDU%2F20250704%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250704T024430Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEBoaCXVzLXdlc3QtMiJIMEYCIQDwNvJ16z%2FYHekw93huqp5jfcw85s08%2Fmo%2Fm%2FLvU8CuGwIhAM%2BBj67s5SqZwysGM2NhfifJSC3Jj5x2PJdsEM1UbJo3Kv8DCCMQABoMNjM3NDIzMTgzODA1Igwx5yB0Wwz5EVcQw64q3ANkqQUcZfPZk9%2FUxbQjtczI6mJddeGjvDpXMR7ooBkrxrTYyq3QG3G1d3%2FIww7%2Bo6xBbJEk6crTkLPAhf0JiAo0%2Fpv8WkEJhUlumTUV6tRBWRAhhVHHYyk%2FWQKSkUYcEVNbHQzuZu9eTWhyCpoR%2BsZZiMB04qquzxK3bhqAK4q8outI9jNu1cFAk8oxHBS3DpTSfsgfSwfApLBeuGrmn9ALROXNlN5m0D%2FaABMKU%2FxTONsrr6Gj1hDEcNfeDgj%2FnDHqJqwswGYZODFhrWNwbEDwj3NjT3NsDaneSXjVKg7AZ9oqrDgRE7IQeoyhEJjsbEFf3ZhyGupBxNfv69u8mowf5ebOo8k959Snu9hOFAels3YJPHUH%2B450opSqFC0b0wjIWy9w9xxKaGF2JB9JNBhOXwIwJbbal5%2BhXajjwtwhr%2FN8HQTDUIeBBh8MqNHkh0tgOTFUAi8dE2n%2Bx9E7jVn6dN6dkH7NwYC0Gwvjd6437pjXKpYeDw6DM8cbNxoYZEYFfw%2FVRLfWaAn%2FbNOYqCyeZqLY%2BiFV7mOUadX%2Fx9Ki0fTkyPhYtIRU8A7LSzDhSdCxXMUAHYZCcDPWXiPkWaajMaTOiUEwRKKS%2BK%2FRvuEHgcSfUmSQAzwVFaE1ADC05pzDBjqkAYOfrv4AQYxNee0cWcOp8ghbJfDCIUrGIXPdwhYqA6%2FGv5z%2FyNyoHum%2BcMVHCXdPCUlNO7IsU44K47x8efC2JfaJtj3%2BcSvJDNvIQD4i7CDdmxdTiPKih6umvXeWc3LFcTeZg7bb2z03m%2FS822M3KUPm7Ye9B%2F2VImdZIMBZ52bfy4I54c4Dyju%2FPZ7dEFBS1pcR5wf9pq7mU%2FmYhdSyIxxTMpv1&X-Amz-Signature=f3711a3f2caab4bd3f963fe7008ef92554e3d706f0ce932881b3a28d344733fe&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)


    æ­¤å‘½ä»¤ä¸ºå­èŠ‚ç‚¹åŠ å…¥å‘½ä»¤ï¼Œè¯·ä¿å­˜

14. å®Œæˆ

    æ ¹æ®æç¤ºï¼Œé…ç½®ä»¥ä¸‹å†…å®¹


    ```shell
    mkdir -p $HOME/.kube
    cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    chown $(id -u):$(id -g) $HOME/.kube/config
    echo "export KUBECONFIG=/etc/kubernetes/admin.conf" >> /etc/profile.d/k8s.sh
    ```


    æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯`kubectl get nodes`


    æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯`kubectl cluster-info`


    é…ç½®podç½‘ç»œæ’ä»¶


    ```shell
    kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
    ```


    æŸ¥çœ‹æ‰€æœ‰podä¿¡æ¯`kubectl get pods --all-namespaces`


## å¸¸ç”¨æ“ä½œå‘½ä»¤


```shell
# éƒ¨ç½²åº”ç”¨
kubectl apply -f app.yaml
# æŸ¥çœ‹deployment
kubectl get deployment
# æŸ¥çœ‹pod
kubectl get pod -o wide
# æŸ¥çœ‹podè¯¦æƒ…
kubectl describe pod pod-name
# æŸ¥çœ‹log
kubectl logs pod-name
# è¿›å…¥podç»ˆç«¯
kubectl exec -it pod-name --bash
# æŒ‡å®šè¿›å…¥çš„å®¹å™¨
kubectl exec -it pod-name -c container-name -- bash
# ä¼¸ç¼©æ‰©å±•å‰¯æœ¬
kubectl scale deployment test-k8s --replicas=5
# æŠŠé›†ç¾¤å†…ç«¯å£æ˜ å°„åˆ°èŠ‚ç‚¹
kubectl port-forword pod-name 8090:8080
# æŸ¥çœ‹å†å²
kubectl rollout history deployment test-k8s
# å›åˆ°ä¸Šä¸ªç‰ˆæœ¬
kubectl rollout undo deployment test-k8s
# å›åˆ°æŒ‡å®šç‰ˆæœ¬
kubectl rollout undo deployment test-k8s --to-revision=2
# åˆ é™¤éƒ¨ç½²
kubectl delete deployment test-k8s
```


# å®‰è£…Rancher

1. å®‰è£…helm

    ```shell
    wget https://github.com/helm/helm/releases/download/v3.11.3/helm-v3.0.0-linux-amd64.tar.gz
    tar -zxvf helm-v3.0.0-linux-amd64.tar.gz
    mv linux-amd64/helm /usr/local/bin/helm
    ```

2. æ·»åŠ helm chartä»“åº“

    ```shell
    helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
    # åˆ›å»ºå‘½åç©ºé—´
    kubectl create namespace cattle-system
    ```

3. ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼Œ[è„šæœ¬å‚è€ƒ](https://docs.rancher.cn/docs/rancher2.5/installation/resources/advanced/self-signed-ssl/_index/#41-%E4%B8%80%E9%94%AE%E7%94%9F%E6%88%90-ssl-%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6%E8%84%9A%E6%9C%AC)ï¼Œå‚è€ƒåç»­éªŒè¯è¯ä¹¦

    ```shell
    # å¦‚æœæ— åŸŸåå¯ä»¥ä¸å¡«å†™--ssl-domainå‚æ•°
    ./create_self-signed-cert.sh --ssl-size=2048 --ssl-date=3650
    # éªŒè¯å è¯·æ·»åŠ TLSå¯†æ–‡
    #åˆ›å»ºingresså¯†é’¥
    kubectl -n cattle-system create secret tls tls-rancher-ingress --cert=./tls.crt --key=./tls.key
    
    #åˆ›å»ºè¯ä¹¦å¯†é’¥
    kubectl -n cattle-system create secret generic tls-ca --from-file=./cacerts.pem
    ```

4. å®‰è£…rancherï¼Œé…ç½®å‚è€ƒ[æ–‡æ¡£](https://ranchermanager.docs.rancher.com/zh/v2.6/pages-for-subheaders/install-upgrade-on-a-kubernetes-cluster#5-%E6%A0%B9%E6%8D%AE%E4%BD%A0%E9%80%89%E6%8B%A9%E7%9A%84%E8%AF%81%E4%B9%A6%E9%80%89%E9%A1%B9%E9%80%9A%E8%BF%87-helm-%E5%AE%89%E8%A3%85-rancher)

    ```shell
    helm install rancher rancher-stable/rancher \
      --namespace cattle-system \
      --set bootstrapPassword=admin \
      --set ingress.tls.source=secret \
      --set replicas=1 \
    # å‡ºé”™ï¼Œéœ€è¦å¸è½½è¯·æ‰§è¡Œ
    # helm uninstall rancher rancher-stable/rancher --namespace cattle-system
    ```


5. æ£€æŸ¥å®‰è£…


    ```shell
    kubectl -n cattle-system rollout status deploy/rancher
    Waiting for deployment "rancher" rollout to finish: 0 of 3 updated replicas are available...
    deployment "rancher" successfully rolled out
    ```


    ```shell
    kubectl -n cattle-system get deploy rancher
    NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
    rancher   3         3         3            3           3m
    ```

1. ç¼–è¾‘é…ç½®æ–‡ä»¶

    ```shell
    kubectl -n cattle-system edit service rancher
    ```

2. ä¿®æ”¹Â `type: ClusterIP`ä¸ºÂ `type: NodePort`

    ```shell
    spec:
    type: NodePort
    ports:  
    - name: http
    port: 443
    targetPort: 444
    nodePort: 30409
    ```

3. æŸ¥çœ‹åˆ†é…çš„ç«¯å£åœ°å€ä¸º30777å’Œ30409

    ```shell
    kubectl -n cattle-system get service rancher
    NAME      TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE
    rancher   NodePort   10.102.224.3   <none>        80:30777/TCP,443:30409/TCP   8m1s
    ```

4. æŸ¥çœ‹åˆå§‹å¯†ç 

    ```shell
    kubectl get secret --namespace cattle-system bootstrap-secret -o go-template='{{.data.bootstrapPassword|base64decode}}{{ "\n" }}'
    ```

5. è®¿é—®https://172.16.0.22:30409ç™»å½•å³å¯
6. å¸è½½rancher [æ–‡æ¡£](https://github.com/rancher/rancher-cleanup)

    ```shell
    kubectl create -f deploy/rancher-cleanup.yaml
    # æŸ¥çœ‹å¸è½½æ—¥å¿—
    kubectl  -n kube-system logs -l job-name=cleanup-job  -f
    ```


# å¼‚å¸¸å¤„ç†

1. ä½¿ç”¨`kubectl -n namespace describe pod`æŸ¥çœ‹podä¿¡æ¯ï¼ŒeventsæŠ¥é”™`0/1 nodes are available: 1 node(s) had untolerated taint {`[`node-role.kubernetes.io/control-plane:`](http://node-role.kubernetes.io/control-plane:) `}. preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling.`

    åŸå› ï¼šç”±äºæ˜¯å•èŠ‚ç‚¹éƒ¨ç½²ï¼Œè€Œé»˜è®¤ä¸»èŠ‚ç‚¹[node-role.kubernetes.io/control-plane](http://node-role.kubernetes.io/control-plane:)ä¸å…è®¸è¢«è°ƒåº¦


    ä¿®å¤æ–¹å¼ï¼šå…è®¸èŠ‚ç‚¹è¢«è°ƒåº¦`kubectl taint nodes --all` [`node-role.kubernetes.io/control-plane`](http://node-role.kubernetes.io/control-plane)`-`


    æ‰©å±•ï¼š`kubectl taint nodes --all` [`node-role.kubernetes.io/control-plane`](http://node-role.kubernetes.io/control-plane)`=:NoSchedule`

    - NoSchedule: ä¸€å®šä¸èƒ½è¢«è°ƒåº¦
    - PreferNoSchedule: å°½é‡ä¸è¦è°ƒåº¦
    - NoExecute: ä¸ä»…ä¸ä¼šè°ƒåº¦, è¿˜ä¼šé©±é€Nodeä¸Šå·²æœ‰çš„Pod
2. `systemctl enable cri-docker.service/cri-docker.socket`æŠ¥é”™Failed to enable unit: Unit file `cri-docker.service/cri-docker.socket` does not exist.

    åŸå› ï¼šSELinuxé…ç½®ä¿¡æ¯é—®é¢˜


    ä¿®å¤æ–¹å¼ï¼šä½¿ç”¨`restorecon`å‘½ä»¤ç”¨æ¥æ¢å¤SELinuxæ–‡ä»¶å±æ€§å³æ¢å¤æ–‡ä»¶çš„å®‰å…¨ä¸Šä¸‹æ–‡ã€‚


    ```shell
    restorecon /etc/systemd/system/cri-docker.service
    systemctl enable cri-docker.service
    Created symlink /etc/systemd/system/multi-user.target.wants/cri-docker.service â†’ /etc/systemd/system/cri-docker.service.
     
    restorecon /etc/systemd/system/cri-docker.socket
    systemctl enable cri-docker.socket
    Created symlink /etc/systemd/system/sockets.target.wants/cri-docker.socket â†’ /etc/systemd/system/cri-docker.socket.
    systemctl start cri-docker
    ```

