---
id: 1738c66d-44b6-45a1-bfeb-f50062d3efec
title: ğŸšï¸ LangGraphå®æˆ˜ å­å›¾ã€æµå“åº”
slug: 1738c66d-44b6-45a1-bfeb-f50062d3efec
excerpt: è®°å½•Langgraphä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä»¥åŠè§£å†³æ–¹æ³•
date: Wed Sep 11 2024 08:00:00 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)
coverImage: /images/1738c66d-44b6-45a1-bfeb-f50062d3efec_9d66b50af6cba34e5b96c55454c6012b.png
lastUpdated: Thu Sep 12 2024 09:28:00 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)
tags: blue:LangGraph
readTime: 2.35
---

## å­å›¾S**ubGraph**


åœ¨é¢å¯¹å¤æ‚çš„workflowæ—¶ï¼Œå°†ä¸åŒçš„åŠŸèƒ½åˆ‡åˆ†ä¸ºå¤šä¸ªå­å›¾ï¼Œå¯ä»¥æ˜¾è‘—çš„æå‡å¼€å‘éš¾åº¦


![local_imager_example.png](/images/1738c66d-44b6-45a1-bfeb-f50062d3efec_c027ef1255359cc82b1711f78c2395c6.png)


ä¸Šå›¾ç¤ºä¾‹ä»£ç 


```python
# Sub graph
class AState(TypedDict):
    standalone_question: str
    answer: str


class AGraph(BaseModel):
    model: BaseChatModel

    async def a_chat(self, state: AState) -> dict:
        """
        A Workflow
        :param state:
        :return:
        """
        question = state["standalone_question"]
        return {"answer": question}

    async def workflow(self, *args: list, **kwargs: dict) -> CompiledGraph:
        workflow = StateGraph(MasterState)

        workflow.add_node("a_chat", self.a_chat)

        workflow.set_entry_point("a_chat")
        workflow.add_edge("a_chat", END)

        return workflow.compile()

# Sub graph
class BState(TypedDict):
    standalone_question: str
    answer: str


class BGraph(BaseModel):
    model: BaseChatModel

    async def b_chat(self, state: AState) -> dict:
        """
        A Workflow
        :param state:
        :return:
        """
        question = state["standalone_question"]
        return {"answer": question}

    async def workflow(self, *args: list, **kwargs: dict) -> CompiledGraph:
        workflow = StateGraph(MasterState)

        workflow.add_node("b_chat", self.b_chat)

        workflow.set_entry_point("b_chat")
        workflow.add_edge("b_chat", END)

        return workflow.compile()

# Master graph
class MasterState(TypedDict):
    question: str
    standalone_question: str
    chat_history: List[AnyMessage]
    answer: str


class MasterGraph(BaseModel):
    model: BaseChatModel

    async def re_write(self, state: MasterState) -> dict:
        """
        é—®é¢˜ é‡å†™
        """
        if not state["chat_history"]:
            return {"standalone_question": state["question"]}
        _template = """Given the following conversation and a follow up question, rephrase the follow up question to be a standalone question.

        Chat History:
        {chat_history}
        Follow Up Input: {question}
        Standalone question:
        """
        rewrite_prompt = ChatPromptTemplate.from_template(_template)
        rewrite = rewrite_prompt | self.model
        response = await rewrite.ainvoke(
            {
                "chat_history": state["chat_history"],
                "question": state["question"],
            }
        )
        return {"standalone_question": response.content}

    async def route(self, state: MasterState) -> Literal["a", "b"]:
        """
        æ¨¡æ‹Ÿé—®é¢˜ è·¯ç”±
        :param state:
        :return:
        """
        question = state["standalone_question"]
        return "a"

    async def workflow(self, *args: list, **kwargs: dict) -> CompiledGraph:
        workflow = StateGraph(MasterState)

        workflow.add_node("re_write", self.re_write)
        workflow.add_node("a", await AGraph(model=self.model).workflow())
        workflow.add_node("b", await BGraph(model=self.model).workflow())

        workflow.set_entry_point("re_write")

        workflow.add_conditional_edges("re_write", self.route, {
            "a": "a",
            "b": "b"
        })

        workflow.add_edge("a", END)
        workflow.add_edge("b", END)

        return workflow.compile()
```


å­å›¾ç›´æ¥ç»§æ‰¿çˆ¶å›¾çš„Stateï¼Œæ‰€ä»¥å­å›¾å¯ä»¥æ–¹ä¾¿çš„**è·å–**å’Œ**é‡å†™**çˆ¶å›¾çš„Stateï¼ŒåŒæ—¶å¯ä»¥æœ‰è‡ªå·±çš„State


## ä½¿ç”¨`astream_events`æµå¼è¾“å‡º


éœ€è¦æ”¹é€ çš„åœ°æ–¹æœ‰ä¸¤ä¸ª

1. éœ€è¦æµå¼è¾“å‡ºçš„èŠ‚ç‚¹ï¼Œæ·»åŠ è‡ªå®šä¹‰`tags`ä½¿ç”¨`astream`ï¼Œå¹¶æ‹¼æ¥answer

    ```python
    async def generate(self, state: State) -> dict:
        rag_chain = rag_prompt | self.model.with_config({"tags": ["answer"]})
        context = "\n".join([doc.page_content for doc in state["docs"]])
        answers = []
        async for chunk in rag_chain.astream({"context": context, "question": state["standalone_question"]}):
            answers.append(chunk.content)
        return {"answer": "".join(answers)}
    ```

2. æœ€ç»ˆè°ƒç”¨çš„æ–¹å¼ï¼Œä½¿ç”¨`astream_events`ï¼Œè¿‡æ»¤è¿”å›çš„`event`ä¸­çš„`tags`å±æ€§ï¼Œä»¥ä¸Šé¢çš„èŠ‚ç‚¹ä¸ºä¾‹

    ```python
    agent = MasterGraph(model=TaliLLM())
    async for event in agent.workflow().astream_events({"question": message, "chat_history": history}, version="v1"):
        kind = event["event"]
        if kind == "on_chat_model_stream" and "answer" in event["tags"]:
            answer += event["data"]["chunk"].content
            print(answer)
    ```

